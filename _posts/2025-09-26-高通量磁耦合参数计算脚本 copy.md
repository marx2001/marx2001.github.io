---
layout: post
title: "高通量DMI计算脚本"
subtitle: "Scripts made by myself"
background: '/img/bg-sci-note.jpg'
categories: sci-note
permalink: /sci-note_posts/20250926-scripts/
---

## <center>用于高通量磁耦合参数计算的脚本</center>

# <center>1.介绍</center>
<p>
　　此脚本用于高通量计算的第三步——J的计算。详细来说，此脚本是高通量结构优化脚本的后续部分。用法如下：将此脚本放置在与结构优化脚本同级别的目录中，直接运行即可，会产生一个5_J的文件夹，同时脚本所在目录也要放置INCAR1、INCAR2、INCAR3、INCAR4文件，后续将用于计算。
</p>

1.qsub 8.pbs，提交任务即可

```shell
#!/bin/bash 
#PBS -l nodes=1:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N test

cd $PBS_O_WORKDIR

echo job id is $PBS_JOBID | tee  pbslog
echo run nodes is following: | tee -a pbslog
cat $PBS_NODEFILE | tee  -a pbslog

echo begin time is `date` | tee -a  pbslog
id=`echo $PBS_JOBID|awk -F. '{print $1}' `
NP=`cat $PBS_NODEFILE|wc -l`


source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source  /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
RUN_1=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std
RUN_2=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> $PBS_JOBID-$PBS_JOBCOOKIE.hosts


# 材料列表
materials=(
VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 创建5_J文件夹
mkdir -p 5_J
cd 5_J

# 循环处理每个材料
for material in "${materials[@]}"
do
  echo "正在处理材料: $material"
  
  # 创建材料文件夹
  mkdir -p "$material"
  cd "$material"
  
  # 从3_geo文件夹复制CONTCAR并重命名为POSCAR
  if [ -f "$PBS_O_WORKDIR/3_geo/$material/CONTCAR" ]; then
    cp "$PBS_O_WORKDIR/3_geo/$material/CONTCAR" POSCAR
    echo "  已从3_geo/$material/CONTCAR复制POSCAR"
  else
    echo "  错误: 找不到 $PBS_O_WORKDIR/3_geo/$material/CONTCAR"
    cd ..
    continue
  fi
  
  # 运行vaspkit生成超胞（修正输入格式）
  echo "运行vaspkit生成超胞..."
  echo -e "401\n1\n3 2 1" | vaspkit
  
  # 重命名文件
  if [ -f "POSCAR" ]; then
    mv POSCAR POSCAR-uc
  fi
  
  # 查找并重命名SC321.vasp文件
  if [ -f "SC321.vasp" ]; then
    mv "SC321.vasp" POSCAR
    echo "  已将SC321.vasp重命名为POSCAR"
  else
    echo "  警告: 未找到SC321.vasp文件"
    # 尝试查找其他可能的超胞文件
    vasp_file=$(find . -name "*.vasp" | head -1)
    if [ -n "$vasp_file" ]; then
      mv "$vasp_file" POSCAR
      echo "  已将 $vasp_file 重命名为 POSCAR"
    else
      echo "  错误: 未找到任何.vasp文件"
      cd ..
      continue
    fi
  fi
  
  # 运行vaspkit生成POTCAR和KPOINTS
  echo "运行vaspkit生成POTCAR和KPOINTS..."
  echo -e "102\n1\n0.03" | vaspkit
  
  # 复制INCAR文件
  cp "$PBS_O_WORKDIR/INCAR1" .
  cp "$PBS_O_WORKDIR/INCAR2" .
  cp "$PBS_O_WORKDIR/INCAR3" .
  cp "$PBS_O_WORKDIR/INCAR4" .
  
  # 运行VASP计算
  for k in 1 2 3 4
  do
    echo "  运行计算 $k"
    mkdir $k
    cd $k
    cp ../POSCAR .
    cp ../POTCAR .
    cp ../KPOINTS .
    cp ../INCAR$k ./INCAR
    
    # 运行VASP
    mpirun -np $NP $RUN_1 > log 2>&1
    
    cd ..
  done
  
  cd ..
done

# 清理
rm -rf $PBS_JOBID-$PBS_JOBCOOKIE.hosts

echo "所有材料计算完成！"
echo end time is `date` | tee -a pbslog

```