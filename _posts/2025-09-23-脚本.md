---
layout: post
title: "批量高通量脚本内容及其注释"
subtitle: "Scripts made by myself"
background: '/img/bg-sci-note.jpg'
categories: sci-note
permalink: /sci-note_posts/20250923-scripts/
---

## <center>用于高通量计算的结构优化脚本</center>

# <center>1.介绍</center>
<p>
　　此脚本用于高通量计算的第一步——结构优化。详细来说，此脚本需要放置在目标目录中，修改数组中材料的名称后，自动产生相应的文件夹。此外，还需要准备一个POSCAR文件。
</p>

<p>
　　脚本的原理是，根据数组创建与材料名称一一对应的文件夹，并复制POSCAR，同时读取文件夹名称中的元素，再替换进POSCAR对应的元素行，这样就能基于这一结构进行高通量计算，要注意的是，必须得是你想要的结构的POSCAR。
</p>
<p>
　　使用脚本的顺序，按照脚本名称一一运行即可。脚本代码如下：
<p>
1.先用sh命令运行1.sh脚本，创建文件夹
</p>
</p>


```shell
#!/bin/bash

echo "开始处理材料..."

# 正确定义材料列表数组
materials=(
VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 循环遍历数组中的每个材料
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  target_dir="$i"
  mkdir -p "$target_dir"
  cd "$target_dir" || exit 1

  # 复制POSCAR文件
  cp ../POSCAR .

  cd ..
done

echo "所有材料处理完毕！"
```


<p>
2.运行2.py，代码如下所示：
</p>


```python
#!/usr/bin/env python
import os
import re
from ase.io import read, write

# 获取当前目录下的所有文件夹
folders = [f for f in os.listdir('.') if os.path.isdir(f)]

# 元素符号正则表达式模式
element_pattern = re.compile(r'[A-Z][a-z]*')

# 处理每个文件夹
for folder in folders:
    # 从文件夹名称中提取元素符号
    folder_elements = element_pattern.findall(folder)
    
    if not folder_elements:
        print(f"跳过文件夹 '{folder}'：未提取到元素符号")
        continue
    
    print(f"处理文件夹 '{folder}'，提取的元素: {folder_elements}")
    
    # 构建POSCAR文件路径
    poscar_path = os.path.join(folder, 'POSCAR')
    
    if not os.path.exists(poscar_path):
        print(f"  警告: 文件夹中未找到POSCAR文件")
        continue
    
    # 读取POSCAR文件
    atoms = read(poscar_path, format='vasp')
    
    # 获取当前POSCAR中的元素符号
    current_symbols = atoms.get_chemical_symbols()
    
    # 获取当前POSCAR中所有唯一的元素（按出现顺序）
    current_unique_elements = []
    for symbol in current_symbols:
        if symbol not in current_unique_elements:
            current_unique_elements.append(symbol)
    
    # 创建一个映射：将当前元素映射到文件夹名称中的元素（从左到右）
    element_mapping = {}
    for i, elem in enumerate(folder_elements):
        if i < len(current_unique_elements):
            element_mapping[current_unique_elements[i]] = elem
    
    # 应用映射到所有原子
    final_symbols = [
        element_mapping.get(symbol, symbol) 
        for symbol in current_symbols
    ]
    
    # 设置新的化学符号
    atoms.set_chemical_symbols(final_symbols)
    
    # 备份原文件
    backup_path = os.path.join(folder, 'POSCAR.bak')
    os.rename(poscar_path, backup_path)
    print(f"  已备份原文件为: {backup_path}")
    
    # 保存新文件
    write(poscar_path, atoms, format='vasp', direct=True, vasp5=True)
    print(f"  已更新文件: {poscar_path}")
    
    # 获取最终的元素顺序
    final_unique_elements = []
    for symbol in final_symbols:
        if symbol not in final_unique_elements:
            final_unique_elements.append(symbol)
    
    print(f"  最终元素顺序: {final_unique_elements}")
    print()

print("所有文件夹处理完成！")
```

3.运行3.pbs

```shell
#!/bin/bash 
#PBS -l nodes=1:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N 35materials_geo

cd $PBS_O_WORKDIR

echo job id is $PBS_JOBID | tee  pbslog
echo run nodes is following: | tee -a pbslog
cat $PBS_NODEFILE | tee  -a pbslog

echo begin time is `date` | tee -a  pbslog
id=`echo $PBS_JOBID|awk -F. '{print $1}' `
NP=`cat $PBS_NODEFILE|wc -l`


source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source  /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
RUN_1=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std
RUN_2=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> $PBS_JOBID-$PBS_JOBCOOKIE.hosts

# 正确定义材料列表数组
materials=(
  VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
  MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
  MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
  MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
  CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
  MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
  MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 循环遍历数组中的每个材料
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  target_dir="$i"
  mkdir -p "$target_dir"
  cd "$target_dir" || exit 1 # 进入目录，如果失败则退出
  echo -e "102\n1\n0.03" | vaspkit > vaspkit_dos.log 2>&1
  vaspkit_exit_code=$?
  if [ $vaspkit_exit_code -ne 0 ]; then
                      echo "错误：在 $target_dir 中执行 vaspkit 失败（错误码 $vaspkit_exit_code）"
                      cd ..
                      continue
                    fi
  cp ../INCAR .
  mpirun -np $NP ${RUN_1} > log 2>&1
  # 计算完成后，清理大文件
  rm -f CHG CHGCAR WAVECAR

  cd .. # 返回上级目录，准备处理下一个材料
done

echo "所有材料处理完毕！"
echo end time is `date` | tee -a pbslog

```