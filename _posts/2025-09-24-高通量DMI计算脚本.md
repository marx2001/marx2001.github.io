---
layout: post
title: "高通量DMI计算脚本"
subtitle: "Scripts made by myself"
background: '/img/bg-sci-note.jpg'
categories: sci-note
permalink: /sci-note_posts/20250924-scripts/
---

## <center>用于高通量DMI计算的脚本</center>

# <center>1.介绍</center>
<p>
　　此脚本用于高通量计算的第二步——DMI计算。详细来说，此脚本是高通量结构优化脚本的后续部分。用法如下：将此脚本放置在与结构优化脚本同级别的目录中，直接运行即可，会产生一个4_DMI的文件夹，同时脚本所在目录也要放置incar.cw和incar.acw文件，后续将用于计算。
</p>

1.qsub 脚本名.pbs，提交任务即可

```shell
#!/bin/bash 
#PBS -l nodes=1:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N 35materials_dmi

cd $PBS_O_WORKDIR

# 创建详细的日志文件
LOG_FILE="dmi_calculation_$(date +%Y%m%d_%H%M%S).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=== DMI计算脚本开始执行 ==="
echo "作业ID: $PBS_JOBID"
echo "运行节点:"
cat $PBS_NODEFILE
echo "开始极间: $(date)"
id=$(echo $PBS_JOBID | awk -F. '{print $1}')
NP=$(cat $PBS_NODEFILE | wc -l)

# 加载环境变量
echo "加载环境变量..."
source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
if [ $? -ne 0 ]; then
    echo "错误：无法加载Intel编译器环境"
    exit 1
fi

source /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
if [ $? -ne 0 ]; then
    echo "错误：无法加载Intel MPI环境"
    exit 1
fi

RUN_1="/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std"
RUN_2="/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl"

# 检查VASP可执行文件是否存在
if [ ! -f "$RUN_1" ]; then
    echo "错误：VASP标准版可执行文件不存在: $RUN_1"
    exit 1
fi

if [ ! -f "$RUN_2" ]; then
    echo "错误：VASP NCL版可执行文件不存在: $RUN_2"
    exit 1
fi

cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> "$PBS_JOBID-$PBS_JOBCOOKIE.hosts"

# 材料列表数组
materials=(
VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
  MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6
  MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
  MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoV极2Se6
  CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
  MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
  MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

echo "材料列表: ${materials[*]}"

# 1. 创建4_DMI文件夹
echo "步骤1: 创建4_DMI文件夹..."
mkdir -p 4_DMI
if [ $? -ne 0 ]; then
    echo "错误：无法创建4_DMI文件夹"
    exit 1
fi
echo "成功创建4_DMI文件夹"

# 2. 从3_geo文件夹复制CONTCAR文件
echo "步骤2: 从3_geo文件夹复制CONTCAR文件..."
COPIED_COUNT=0
for i in "${materials[@]}"
do
  echo "处理材料: $i"
  
  # 检查3_geo中的材料文件夹是否存在
  if [ ! -d "3_geo/$i" ]; then
    echo "警告：目录 3_geo/$i 不存在，跳过此材料"
    continue
  fi
  
  # 检查CONTCAR文件是否存在
  if [ ! -f "3_geo/$i/CONTCAR" ]; then
    echo "警告：CONTCAR文件 3_geo/$i/CONTCAR 不存在，跳过此材料"
    continue
  fi
  
  # 在4_DMI中创建材料文件夹
  mkdir -p "4_DMI/$i"
  if [ $? -ne 0 ]; then
    echo "错误：无法创建目录 4_DMI/$i"
    continue
  fi
  
  # 复制CONTCAR到4_DMI/材料名/POSCAR
  cp "3_geo/$i/CONTCAR" "4_DMI/$i/POSCAR"
  if [ $? -ne 0 ]; then
    echo "错误：复制 CONTCAR 失败，从 3_geo/$i/CONTCAR 到 4_DMI/$i/POSCAR"
    continue
  fi
  
  echo "成功复制 CONTCAR 到 4_DMI/$i/POSCAR"
  ((COPIED_COUNT++))
done

echo "已完成CONTCAR复制，共处理了 $COPIED_COUNT 个文件"

# 3. 在4_DMI文件夹中处理每个材料
echo "步骤3: 在4_DMI文件夹中处理每个材料..."
PROCESSED_COUNT=0
for i in "${materials[@]}"
do
  echo "开始处理材料: $i"
  
  # 检查POSCAR文件是否存在
  if [ ! -f "4_DMI/$i/POSCAR" ]; then
    echo "警告：POSCAR文件 4_DMI/$i/POSCAR 不存在，跳过此材料"
    continue
  fi
  
  # 进入材料文件夹
  cd "4_DMI/$i"
  if [ $? -ne 0 ]; then
    echo "错误：无法进入目录 4_DMI/$i"
    continue
  fi
  
  # 设置 Fortran 环境变量
  export FORT_BUFFERED=TRUE
  export FORT_CONVERTED_BIG_ENDIAN=TRUE
  
  # 运行vaspkit生成SC411.vasp
  echo "运行vaspkit生成SC411.vasp..."
  
  # 创建输入文件
  echo -e "401\n1\n4 1 1" | vaspkit > vaspkit_dmi.log 2>&1
  VASPKIT_EXIT_CODE=$?
  
  if [ $VASPKIT_EXIT_CODE -ne 0 ]; then
    echo "错误：vaspkit 401命令执行失败（退出码 $VASPKIT_EXIT_CODE）"
    echo "查看 vaspkit_dmi.log 获取详细信息"
    cat vaspkit_dmi.log
    cd ../..
    continue
  fi
  
  # 检查 SC411.vasp 是否生成
  if [ ! -f "SC411.vasp" ]; then
    echo "错误：SC411.vasp文件未生成"
    echo "vaspkit 输出:"
    cat vaspkit_dmi.log
    cd ../..
    continue
  fi
  
  # 删除原有POSCAR，将SC411.vasp重命名为POSCAR
  rm -f POSCAR
  mv SC411.vasp POSCAR
  echo "成功将SC411.vasp重命名为POSCAR"
  
  # 使用vaspkit生成输入文件
  echo "使用vaspkit生成输入文件..."
  echo -e "102\n1\n0.03" | vaspkit > vaspkit_input.log 2>&1
  VASPKIT_EXIT_CODE=$?
  
  if [ $VASPKIT_EXIT_CODE -ne 0 ]; then
    echo "错误：vaspkit 102命令执行失败（退出码 $VASPKIT_EXIT_CODE）"
    echo "查看 vaspkit_input.log 获取详细信息"
    cat vaspkit_input.log
    cd ../..
    continue
  fi
  
  # 从脚本所在目录复制incar.cw和incar.acw
  echo "复制incar.cw和incar.acw文件..."
  cp "$PBS_O_WORKDIR/incar.cw" .
  if [ $? -ne 0 ]; then
    echo "错误：复制incar.cw失败"
    cd ../..
    continue
  fi
  
  cp "$PBS_O_WORKDIR/incar.acw" .
  if [ $? -ne 0 ]; then
    echo "错误：复制incar.acw失败"
    cd ../..
    continue
  fi
  
  # 创建cw文件夹
  echo "创建cw文件夹..."
  mkdir -p cw
  if [ $? -ne 0 ]; then
    echo "错误：创建cw文件夹失败"
    cd ../..
    continue
  fi
  
  # 处理cw文件夹
  echo "处理cw文件夹..."
  cd cw
  if [ $? -ne 0 ]; then
    echo "错误：无法进入cw目录"
    cd ..
    cd ../..
    continue
  fi
  
  # 复制incar.cw并重命名为INCAR
  cp ../incar.cw INCAR
  if [ $? -ne 0 ]; then
    echo "错误：复制incar.cw到INCAR失败"
    cd ..
    cd ../..
    continue
  fi
  
  # 复制其他必要文件
  cp ../KPOINTS .
  cp ../POTCAR .
  cp ../POSCAR .
  
  # 运行VASP计算
  echo "开始cw方向的VASP计算..."
  mpirun -np $NP ${RUN_2} > log 2>&1
  VASP_EXIT_CODE=$?
  if [ $VASP_EXIT_CODE -ne 0 ]; then
    echo "警告：VASP计算可能出错（退出码 $VASP_EXIT_CODE）"
  else
    echo "cw方向VASP计算完成"
  fi
  
  # 计算完成后，清理大文件
  echo "清理cw方向的大文件..."
  rm -f CHG CHGCAR WAVECAR
  
  # 返回材料目录
  cd ..
  
  # 创建acw文件夹
  echo "创建acw文件夹..."
  mkdir -p acw
  if [ $? -ne 0 ]; then
    echo "错误：创建acw文件夹失败"
    cd ../..
    continue
  fi
  
  # 处理acw文件夹
  echo "处理acw文件夹..."
  cd acw
  if [ $? -ne 0 ]; then
    echo "错误：无法进入acw目录"
    cd ../..
    continue
  fi
  
  # 复制incar.acw并重命名为INCAR
  cp ../incar.acw INCAR
  if [ $? -ne 0 ]; then
    echo "错误：复制incar.acw到INCAR失败"
    cd ../..
    continue
  fi
  
  # 复制其他必要文件
  cp ../KPOINTS .
  cp ../POTCAR .
  cp ../POSCAR .
  
  # 运行VASP计算
  echo "开始acw方向的VASP计算..."
  mpirun -np $NP ${RUN_2} > log 2>&1
  VASP_EXIT_CODE=$?
  if [ $VASP_EXIT_CODE -ne 0 ]; then
    echo "警告：VASP计算可能出错（退出码 $VASP_EXIT_CODE）"
  else
    echo "acw方向VASP计算完成"
  fi
  
  # 计算完成后，清理大文件
  echo "清理acw方向的大文件..."
  rm -f CHG CHGCAR WAVECAR
  
  # 返回原始工作目录
  cd ../../..
  
  echo "完成材料 $i 的处理"
  ((PROCESSED_COUNT++))
done

echo "所有材料DMI计算处理完毕！共成功处理 $PROCESSED_COUNT 个材料"
echo "结束时间: $(date)"
echo "=== DMI计算脚本执行完成 ==="

# 同时将重要信息也输出到pbslog
echo "所有材料DMI计算处理完毕！" | tee -a pbslog
echo "结束时间: $(date)" | tee -a pbslog

```