---
layout: post
title: "高通量结构优化脚本"
subtitle: "Scripts made by myself"
background: '/img/bg-sci-note.jpg'
categories: sci-note
#permalink: /sci-note_posts/20250923-scripts/
---

## <center>用于高通量计算的结构优化脚本</center>

# <center>1.介绍</center>
<p>
　　此脚本用于高通量计算的第一步——结构优化。详细来说，此脚本需要放置在目标目录中，修改数组中材料的名称后，自动产生相应的文件夹。此外，还需要准备一个POSCAR文件。
</p>

<p>
　　脚本的原理是，根据数组创建与材料名称一一对应的文件夹，并复制POSCAR，同时读取文件夹名称中的元素，再替换进POSCAR对应的元素行，这样就能基于这一结构进行高通量计算，要注意的是，必须得是你想要的结构的POSCAR。
</p>
<p>
　　使用脚本的顺序，按照脚本名称一一运行即可。脚本代码如下：
<p>
1.先用sh命令运行1.sh脚本，创建文件夹
</p>
</p>


```shell
#!/bin/bash

echo "开始处理材料..."

# 正确定义材料列表数组
materials=(
VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 循环遍历数组中的每个材料
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  target_dir="$i"
  mkdir -p "$target_dir"
  cd "$target_dir" || exit 1

  # 复制POSCAR文件
  cp ../POSCAR .

  cd ..
done

echo "所有材料处理完毕！"
```


<p>
2.运行2.py，代码如下所示：
</p>


```python
#!/usr/bin/env python
import os
import re
from ase.io import read, write

# 获取当前目录下的所有文件夹
folders = [f for f in os.listdir('.') if os.path.isdir(f)]

# 元素符号正则表达式模式
element_pattern = re.compile(r'[A-Z][a-z]*')

# 处理每个文件夹
for folder in folders:
    # 从文件夹名称中提取元素符号
    folder_elements = element_pattern.findall(folder)
    
    if not folder_elements:
        print(f"跳过文件夹 '{folder}'：未提取到元素符号")
        continue
    
    print(f"处理文件夹 '{folder}'，提取的元素: {folder_elements}")
    
    # 构建POSCAR文件路径
    poscar_path = os.path.join(folder, 'POSCAR')
    
    if not os.path.exists(poscar_path):
        print(f"  警告: 文件夹中未找到POSCAR文件")
        continue
    
    # 读取POSCAR文件
    atoms = read(poscar_path, format='vasp')
    
    # 获取当前POSCAR中的元素符号
    current_symbols = atoms.get_chemical_symbols()
    
    # 获取当前POSCAR中所有唯一的元素（按出现顺序）
    current_unique_elements = []
    for symbol in current_symbols:
        if symbol not in current_unique_elements:
            current_unique_elements.append(symbol)
    
    # 创建一个映射：将当前元素映射到文件夹名称中的元素（从左到右）
    element_mapping = {}
    for i, elem in enumerate(folder_elements):
        if i < len(current_unique_elements):
            element_mapping[current_unique_elements[i]] = elem
    
    # 应用映射到所有原子
    final_symbols = [
        element_mapping.get(symbol, symbol) 
        for symbol in current_symbols
    ]
    
    # 设置新的化学符号
    atoms.set_chemical_symbols(final_symbols)
    
    # 备份原文件
    backup_path = os.path.join(folder, 'POSCAR.bak')
    os.rename(poscar_path, backup_path)
    print(f"  已备份原文件为: {backup_path}")
    
    # 保存新文件
    write(poscar_path, atoms, format='vasp', direct=True, vasp5=True)
    print(f"  已更新文件: {poscar_path}")
    
    # 获取最终的元素顺序
    final_unique_elements = []
    for symbol in final_symbols:
        if symbol not in final_unique_elements:
            final_unique_elements.append(symbol)
    
    print(f"  最终元素顺序: {final_unique_elements}")
    print()

print("所有文件夹处理完成！")
```

3.运行3.pbs，开始结构优化，此时INCAR中力的收敛标准和能量收敛标准均是较低的，1e-4，-0.1的收敛标准

```shell
#!/bin/bash 
#PBS -l nodes=1:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N 35materials_geo

cd $PBS_O_WORKDIR

echo job id is $PBS_JOBID | tee  pbslog
echo run nodes is following: | tee -a pbslog
cat $PBS_NODEFILE | tee  -a pbslog

echo begin time is `date` | tee -a  pbslog
id=`echo $PBS_JOBID|awk -F. '{print $1}' `
NP=`cat $PBS_NODEFILE|wc -l`


source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source  /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
RUN_1=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std
RUN_2=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> $PBS_JOBID-$PBS_JOBCOOKIE.hosts

# 正确定义材料列表数组
materials=(
  VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
  MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
  MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
  MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
  CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
  MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
  MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 循环遍历数组中的每个材料
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  target_dir="$i"
  mkdir -p "$target_dir"
  cd "$target_dir" || exit 1 # 进入目录，如果失败则退出
  echo -e "102\n1\n0.03" | vaspkit > vaspkit_dos.log 2>&1
  vaspkit_exit_code=$?
  if [ $vaspkit_exit_code -ne 0 ]; then
                      echo "错误：在 $target_dir 中执行 vaspkit 失败（错误码 $vaspkit_exit_code）"
                      cd ..
                      continue
                    fi
  cp ../INCAR .
  mpirun -np $NP ${RUN_1} > log 2>&1
  # 计算完成后，清理大文件
  rm -f CHG CHGCAR WAVECAR

  cd .. # 返回上级目录，准备处理下一个材料
done

echo "所有材料处理完毕！"
echo end time is `date` | tee -a pbslog

```
4.在运行下一步脚本之前，记得更改INCAR中的收敛标准（1e-6,-0.05），因为只有逐步提高收敛标准，才能获得比较准确的结构优化结果。

```shell
#!/bin/bash 
#PBS -l nodes=node19:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N 35materials_geo2

cd $PBS_O_WORKDIR

echo job id is $PBS_JOBID | tee  pbslog
echo run nodes is following: | tee -a pbslog
cat $PBS_NODEFILE | tee  -a pbslog

echo begin time is `date` | tee -a  pbslog
id=`echo $PBS_JOBID|awk -F. '{print $1}' `
NP=`cat $PBS_NODEFILE|wc -l`

source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source  /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
RUN_1=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std
RUN_2=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> $PBS_JOBID-$PBS_JOBCOOKIE.hosts

# 正确定义材料列表数组
materials=(
  VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se6 CrGaGe2S6
  MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 MnCuGe2Se6
  MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
  MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoVGe2S6 CoVGe2Se6
  CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
  MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
  MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 循环遍历数组中的每个材料
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  target_dir="$i"
  
  # 1. 进入材料目录
  cd "$target_dir" || { echo "无法进入目录 $target_dir"; exit 1; }
  
  # 2. 在材料目录内创建geo_2子目录
  mkdir -p "geo_2"
  
  # 3. 进入geo_2目录
  cd "geo_2" || { echo "无法进入geo_2目录"; exit 1; }
  
  # 4. 从上层目录复制CONTCAR作为POSCAR
  cp ../CONTCAR POSCAR || { echo "复制CONTCAR失败"; exit 1; }
  
  # 5. 运行vaspkit生成输入文件
  echo -e "102\n1\n0.03" | vaspkit > vaspkit_dos.log 2>&1
  vaspkit_exit_code=$?
  if [ $vaspkit_exit_code -ne 0 ]; then
    echo "错误：在 $target_dir/geo_2 中执行 vaspkit 失败（错误码 $vaspkit_exit_code）"
    cd ../..  # 返回原始工作目录
    continue
  fi
  
  # 6. 从上上层目录复制INCAR
  cp ../../INCAR . || { echo "复制INCAR失败"; exit 1; }
  
  # 7. 运行VASP计算
  mpirun -np $NP ${RUN_1} > log 2>&1
  
  # 8. 计算完成后，清理大文件
  rm -f CHG CHGCAR WAVECAR
  
  # 9. 返回原始工作目录（两次cd..）
  cd ../..
done

echo "所有材料处理完毕！"
echo end time is `date` | tee -a pbslog

```

5.最后一次结构优化，收敛标准提到1e-6,-0.01,此时的结构已足以计算磁参数等性质，计算声子谱时可以设置收敛标准1e-8，-0.001

```shell
#!/bin/bash 
#PBS -l nodes=1:ppn=64
#PBS -l walltime=640:01:00 
#PBS -j oe
#PBS -q sugon
#PBS -N 35materials_geo

cd $PBS_O_WORKDIR

echo job id is $PBS_JOBID | tee pbslog
echo run nodes is following: | tee -a pbslog
cat $PBS_NODEFILE | tee -a pbslog

echo begin time is `date` | tee -a pbslog
id=`echo $PBS_JOBID|awk -F. '{print $1}'`
NP=`cat $PBS_NODEFILE|wc -l`

source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 
RUN_1=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_std
RUN_2=/public/home/cssong/app/vasp/intel_2021.3.0/5.4.4/vasp_ncl
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' >> $PBS_JOBID-$PBS_JOBCOOKIE.hosts

# 正确定义材料列表数组
#materials=(
#VScGe2S6 VGaGe2S6 VCdGe2Te6 CrScGe2Se极 CrGaGe2S6
#MnVGe2S6 MnNiGe2Te6 MnAgGe2Se6 MnAgGe2Te6 
#MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
#MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoV极2S6 CoVGe2Se6
#CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
#MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
#MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
#)

materials=(
MnGaGe2Se6 MnHgGe2Te6 MnIrGe2S6 MnIrGe2Se6 MnScGe2Se6
MnCoGe2Te6 FeZnGe2S6 FeZnGe2Se6 CoV极2S6 CoVGe2Se6
CoVGe2Te6 CoMoGe2Se6 CoMoGe2Te6 CoRuGe2Te6 NbCdGe2Te6
MoAgGe2S6 MoAgGe2Te6 MoCdGe2Se6 MoHgGe2S6 MoPbGe2Se6
MoSnGe2Te6 MoBiGe2Se6 TcAgGe2S6 TcCdGe2S6 ReScGe2Se6
)

# 1. 创建3_geo文件夹
echo "创建3_geo文件夹..."
mkdir -p 3_geo
if [ $? -eq 0 ]; then
    echo "成功创建3_geo文件夹"
else
    echo "错误：无法创建3_geo文件夹"
    exit 1
fi

# 2. 循环遍历数组中的每个材料
echo "开始复制CONTCAR文件..."
for i in "${materials[@]}"
do
  echo "正在处理材料: $i"
  
  # 2.1 检查geo_2文件夹是否存在
  if [ ! -d "$i/geo_2" ]; then
    echo "警告：目录 $i/geo_2 不存在，跳过此材料"
    continue
  fi
  
  # 2.2 进入材料目录的geo_2文件夹
  echo "进入目录 $i/geo_2"
  cd "$i/geo_2" || { echo "错误：无法进入目录 $i/geo_2"; continue; }
  
  # 2.3 检查CONTCAR文件是否存在
  if [ ! -f "CONTCAR" ]; then
    echo "警告：CONTCAR文件不存在于 $i/geo_2，跳过此材料"
    cd ../..
    continue
  fi
  
  # 2.4 复制CONTCAR
  echo "复制CONTCAR到 ../../3_geo/${i}_CONTCAR"
  cp CONTCAR ../../3_geo/"$i"_CONTCAR
  if [ $? -eq 0 ]; then
    echo "成功复制CONTCAR"
  else
    echo "错误：复制CONTCAR失败"
    cd ../..
    continue
  fi
  
  # 2.5 返回两次到脚本所在目录
  cd ../..
  echo "返回脚本所在目录"
done

echo "已完成CONTCAR复制，共处理了 $(ls 3_geo/*_CONTCAR 2>/dev/null | wc -l) 个文件"

# 3. 在3_geo文件夹中为每种材料创建子文件夹
echo "开始在3_geo中创建材料子文件夹..."
for i in "${materials[@]}"
do
  # 3.1 检查CONTCAR文件是否存在
  if [ ! -f "3_geo/${i}_CONTCAR" ]; then
    echo "警告：CONTCAR文件 3_geo/${i}_CONTCAR 不存在，跳过此材料"
    continue
  fi
  
  # 3.2 在3_geo中创建材料文件夹
  echo "创建目录 3_geo/$i"
  mkdir -p "3_geo/$i"
  if [ $? -eq 0 ]; then
    echo "成功创建目录 3_geo/$i"
  else
    echo "错误：无法创建目录 3_geo/$i"
    continue
  fi
  
  # 3.3 将复制的CONTCAR移动到新文件夹并重命名为POSCAR
  echo "移动文件 3_geo/${i}_CONTCAR 到 3_geo/$i/POSCAR"
  mv "3_geo/${i}_CONTCAR" "3_geo/$i/POSCAR"
  if [ $? -eq 0 ]; then
    echo "成功移动文件"
  else
    echo "错误：移动文件失败"
    continue
  fi
  
  # 3.4 进入新创建的材料文件夹
  echo "进入目录 3_geo/$i"
  cd "3_geo/$i" || { echo "错误：无法进入目录 3_geo/$i"; continue; }
  
  # 3.5 运行vaspkit生成输入文件
  echo "运行vaspkit生成输入文件..."
  echo -e "102\n1\n0.03" | vaspkit > vaspkit_dos.log 2>&1
  vaspkit_exit_code=$?
  if [ $vaspkit_exit_code -eq 0 ]; then
    echo "vaspkit运行成功"
  else
    echo "错误：在 3_geo/$i 中执行 vaspkit 失败（错误码 $vaspkit_exit_code）"
    cd ../..  # 返回原始工作目录
    continue
  fi
  
  # 3.6 从脚本所在目录复制INCAR到当前目录
  echo "复制INCAR文件..."
  cp $PBS_O_WORKDIR/INCAR .
  if [ $? -eq 0 ]; then
    echo "成功复制INCAR"
  else
    echo "错误：复制INCAR失败"
    cd ../..
    continue
  fi
  
  # 3.7 运行VASP计算
  echo "开始VASP计算..."
  mpirun -np $NP ${RUN_1} > log 2>&1
  vasp_exit_code=$?
  if [ $vasp_exit_code -eq 0 ]; then
    echo "VASP计算完成"
  else
    echo "警告：VASP计算可能出错（退出码 $vasp_exit_code）"
  fi
  
  # 3.8 计算完成后，清理大文件
  echo "清理大文件..."
  rm -f CHG CHGCAR WAVECAR
  echo "清理完成"
  
  # 3.9 返回原始工作目录
  cd ../..
  echo "返回脚本所在目录"
done

echo "所有材料处理完毕！"
echo end time is `date` | tee -a pbslog

```