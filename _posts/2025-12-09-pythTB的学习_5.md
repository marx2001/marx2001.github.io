---
layout: post
title: "pythTB的学习_Parameterized_TBModel"
subtitle: "Experience Sharing"
background: '/img/bg-sci-note.jpg'
categories: sci-note
permalink: /sci-note_posts/20251209-Parameterized_TBModel
---


# <center>Tutorials​</center>

### 初始化与填充 WFArray

本教程展示了如何在PythTB中构建参数化的紧束缚模型，如何针对不同参数值对模型进行评估，以及如何将这些参数永久“固化”到模型中。

####核心要点​

在整个过程中，请始终记住：所有参数值都以标量（或在扫描时以一维标量数组）的形式被使用。

你将学习到​

定义符号化的跃迁项/在位项。

在参数扫描中评估哈密顿量、本征值等。

通过以下方法永久“固化”参数：

使用 TBModel.set_parameters直接设置。

使用 TBModel.with_parameters返回一个参数固定的模型副本。

扩展到自旋相关的模型，演示如何以参数化方式提供 2×2 矩阵块。

```python

import numpy as np
from pythtb import TBModel, Lattice

```

### 无自旋模型与符号化跃迁

我们从一个在类蜂窝晶格上的熟悉的两轨道无自旋模型开始。最近邻跃迁由单一符号 t 参数化。

```python

lat_vecs = [[1.0, 0.0], [0.5, np.sqrt(3.0) / 2.0]]
orb_vecs = [[0.0, 0.0], [1.0 / 3.0, 1.0 / 3.0]]

lattice = Lattice(lat_vecs, orb_vecs, periodic_dirs=...)
tb = TBModel(lattice)

# Fixed on-site energies
tb.set_onsite([0.0, 0.0])

# Symbolic nearest-neighbour hopping: string 't'
tb.set_hop("t", 0, 1, [0, 0])
tb.set_hop(0.3, 1, 0, [1, 0])
tb.set_hop(0.1, 1, 0, [0, 1])

```

目前，模型已识别出其依赖一个名为 t​ 的参数。请注意下方打印输出中，位点0到位点1的跃迁（晶格矢量 [0, 0] 处）被表示为 t，而其他跃迁值则显示为数值。

```python

tb.parameters

```

```python

[{'kind': 'hopping', 'orbitals': (0, 1), 'R': (0, 0), 'names': ('t',)}]

```

```python

print(tb)

```

```python

----------------------------------------
       Tight-binding model report       
----------------------------------------
r-space dimension           = 2
k-space dimension           = 2
periodic directions         = [0, 1]
spinful                     = False
number of spin components   = 1
number of electronic states = 2
number of orbitals          = 2

Lattice vectors (Cartesian):
  # 0 ===> [ 1.000,  0.000]
  # 1 ===> [ 0.500,  0.866]
Volume of unit cell (Cartesian) = 0.866 [A^d]

Reciprocal lattice vectors (Cartesian):
  # 0 ===> [ 6.283, -3.628]
  # 1 ===> [ 0.000,  7.255]
Volume of reciprocal unit cell = 45.586 [A^-d]

Orbital vectors (Cartesian):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.289]

Orbital vectors (fractional):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.333,  0.333]
----------------------------------------
Site energies:
  < 0 | H | 0 > =  0.000 
  < 1 | H | 1 > =  0.000 
Hoppings:
  < 1 | H | 0  + [ 1.0 ,  0.0 ] > = 0.3000+0.0000j
  < 1 | H | 0  + [ 0.0 ,  1.0 ] > = 0.1000+0.0000j
  < 0 | H | 1  + [ 0.0 ,  0.0 ] > = 't'
Hopping distances:
  | pos( 1 ) - pos( 0 ) + [ 1.0 ,  0.0 ] | =   0.577
  | pos( 1 ) - pos( 0 ) + [ 0.0 ,  1.0 ] | =   0.577
  | pos( 0 ) - pos( 1 ) + [ 0.0 ,  0.0 ] | =   0.577 (param)

```

例如，如果我们尝试在不提供 t​ 的情况下构建哈密顿量，PythTB 会引发错误，因为符号 t​ 没有具体数值。

```python
try:
    tb.hamiltonian()
except ValueError as exc:
    print(exc)
```

```python

Missing parameter value(s): t

```

### 在评估过程中提供参数值

每一个评估例程（例如hamiltonian、solve_ham、velocity等）都接受对应参数的关键字参数。参数值可以是标量，也可以是一维标量数组。

```python

k_mesh = tb.k_uniform_mesh([20, 20])

# Single value (scalar)
H_single = tb.hamiltonian(k_mesh, t=0.5)

# Sweep over five scalar values (1-D array of scalars)
t_values = np.linspace(-1.0, 1.0, 5)
H_sweep = tb.hamiltonian(k_mesh, t=t_values)

print("Hamiltonian shape with t=0.5:")
print(H_single.shape)
print("Hamiltonian shape sweeping over 5 t values:")
print(H_sweep.shape)

```

```python

Hamiltonian shape with t=0.5:
(400, 2, 2)
Hamiltonian shape sweeping over 5 t values:
(400, 5, 2, 2)

```

扫描结果的参数轴会附加在k点轴之后。在此例中，每个k点对应5个参数值t，而k点共有400个，因此哈密顿量数组的最终形状为 (400, 5, 2, 2)。solve_ham 函数遵循相同的处理模式。

```python

evals_single = tb.solve_ham(k_mesh, t=0.5)  # passing a single scalar value
evals_sweep = tb.solve_ham(k_mesh, t=t_values)  # passing a 1-D array of scalars

print("Energies shape with t=0.5:")
print(evals_single.shape)
print("Energies shape sweeping over 5 t values:")
print(evals_sweep.shape)

```

```python

Energies shape with t=0.5:
(400, 2)
Energies shape sweeping over 5 t values:
(400, 5, 2)

```

该方法也以相同的方式接受参数值。一个重要的注意事项是：当提供参数扫描时，哈密顿量相对于参数范围的导数是通过有限差分计算的，并连同k导数一起附加到主轴上。





```python

velocity_single = tb.velocity(k_mesh, t=0.5)
velocity_sweep = tb.velocity(k_mesh, t=t_values)

print("Velocity shape with t=0.5:")
print(velocity_single.shape)
print("Velocity shape sweeping over 5 t values:")
print(velocity_sweep.shape)

```
注意​

当传递一个标量时，速度数组的形状是 (2, 400, 2, 2)，其中 t是参数。

当传递 5 个值的扫描时，速度数组的形状变为 (3, 400, 5, 2, 2)。此时，在 k 值轴之后添加了一个参数值轴，同时关于 t的有限差分导数被附加在最前面的轴上。

形状说明​

标量参数：(2, 400, 2, 2)表示 2 个导数分量，400 个 k 点，2 个轨道，2 个轨道。

参数扫描：(3, 400, 5, 2, 2)表示 3 个导数分量（包括对 t 的导数），400 个 k 点，5 个参数值，2 个轨道，2 个轨道

```python

Velocity shape with t=0.5:
(2, 400, 2, 2)
Velocity shape sweeping over 5 t values:
(3, 400, 5, 2, 2)

```

### 固定参数

TBModel.set_parameters方法会将符号化的提供方（字符串或可调用对象）替换为您指定的数值。调用此方法后，这些项将变为永久固定的数值。

#### 重要提示
传递到 set_parameters方法的每个参数必须是标量。标量数组仅允许用于评估例程（如计算哈密顿量、能带等），而不能用于固定模型参数。

```python

tb.set_parameters(t=0.8)
tb.parameters

```

```python

[]

```

```python

print(tb)

----------------------------------------
       Tight-binding model report       
----------------------------------------
r-space dimension           = 2
k-space dimension           = 2
periodic directions         = [0, 1]
spinful                     = False
number of spin components   = 1
number of electronic states = 2
number of orbitals          = 2

Lattice vectors (Cartesian):
  # 0 ===> [ 1.000,  0.000]
  # 1 ===> [ 0.500,  0.866]
Volume of unit cell (Cartesian) = 0.866 [A^d]

Reciprocal lattice vectors (Cartesian):
  # 0 ===> [ 6.283, -3.628]
  # 1 ===> [ 0.000,  7.255]
Volume of reciprocal unit cell = 45.586 [A^-d]

Orbital vectors (Cartesian):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.289]

Orbital vectors (fractional):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.333,  0.333]
----------------------------------------
Site energies:
  < 0 | H | 0 > =  0.000 
  < 1 | H | 1 > =  0.000 
Hoppings:
  < 1 | H | 0  + [ 1.0 ,  0.0 ] > = 0.3000+0.0000j
  < 1 | H | 0  + [ 0.0 ,  1.0 ] > = 0.1000+0.0000j
  < 0 | H | 1  + [ 0.0 ,  0.0 ] > = 0.8000+0.0000j
Hopping distances:
  | pos( 1 ) - pos( 0 ) + [ 1.0 ,  0.0 ] | =   0.577
  | pos( 1 ) - pos( 0 ) + [ 0.0 ,  1.0 ] | =   0.577
  | pos( 0 ) - pos( 1 ) + [ 0.0 ,  0.0 ] | =   0.577
```

```python
# Once frozen, the model no longer expects 't'
H_frozen = tb.hamiltonian(k_mesh)
print("Hamiltonian shape after freezing parameters:")
print(H_frozen.shape)
```
```python

Hamiltonian shape after freezing parameters:
(400, 2, 2)

```


如果您不希望修改原始模型，可以使用 TBModel.with_parameters方法。此方法会返回一个指定参数已被冻结的副本。


```python

tb_symbolic = TBModel(lattice)
tb_symbolic.set_onsite([0.0, 0.0])
tb_symbolic.set_hop("t", 0, 1, [0, 0])
tb_symbolic.set_hop(0.3, 1, 0, [1, 0])
tb_symbolic.set_hop(0.1, 1, 0, [0, 1])

tb_frozen = tb_symbolic.with_parameters(t=0.3)

# tb_symbolic still demands a parameter, tb_frozen does not
try:
    tb_symbolic.hamiltonian(k_mesh)
except ValueError as exc:
    print("symbolic:", exc)

H_frozen = tb_frozen.hamiltonian(k_mesh)
print("Frozen Hamiltonian shape:")
print(H_frozen.shape)

```

```python

symbolic: Missing parameter value(s): t
Frozen Hamiltonian shape:
(400, 2, 2)

```

### 无自旋模型与多重符号化跃迁项

本次我们创建一个包含多个符号化跃迁项的模型。这些参数可以使用相同的名称，也可以使用不同的名称。当进行评估时，具有相同名称的参数将共享相同的数值。如下所示，两个轨道共享同一个 onsite 参数，
并且两个跃迁具有不同的参数名称 m、t1 和 t2。


```python

lat_vecs = [[1, 0], [0, 1]]
orb_vecs = [[0, 0], [1 / 2, 1 / 2]]
lat = Lattice(lat_vecs=lat_vecs, orb_vecs=orb_vecs, periodic_dirs=...)
model = TBModel(lattice=lat, spinful=False)

model.set_onsite("m", ind_i=0)
model.set_onsite("m", ind_i=1)
model.set_hop("t1", 0, 1, [0, 0])
model.set_hop("t2", 1, 0, [0, 1])
print(model)

```

```python

----------------------------------------
       Tight-binding model report       
----------------------------------------
r-space dimension           = 2
k-space dimension           = 2
periodic directions         = [0, 1]
spinful                     = False
number of spin components   = 1
number of electronic states = 2
number of orbitals          = 2

Lattice vectors (Cartesian):
  # 0 ===> [ 1.000,  0.000]
  # 1 ===> [ 0.000,  1.000]
Volume of unit cell (Cartesian) = 1.000 [A^d]

Reciprocal lattice vectors (Cartesian):
  # 0 ===> [ 6.283,  0.000]
  # 1 ===> [ 0.000,  6.283]
Volume of reciprocal unit cell = 39.478 [A^-d]

Orbital vectors (Cartesian):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.500]

Orbital vectors (fractional):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.500]
----------------------------------------
Site energies:
  < 0 | H | 0 > = 'm'
  < 1 | H | 1 > = 'm'
Hoppings:
  < 0 | H | 1  + [ 0.0 ,  0.0 ] > = 't1'
  < 1 | H | 0  + [ 0.0 ,  1.0 ] > = 't2'
Hopping distances:
  | pos( 0 ) - pos( 1 ) + [ 0.0 ,  0.0 ] | =   0.707 (param)
  | pos( 1 ) - pos( 0 ) + [ 0.0 ,  1.0 ] | =   0.707 (param)

```

下面我们将把其中两个参数设置为具体数值，而将 t2 保留为一个自由参数，以便在后续计算中再指定。

```python

model.set_parameters(m=1, t1=0.8)

print(model)

```
结果：

```python

----------------------------------------
       Tight-binding model report       
----------------------------------------
r-space dimension           = 2
k-space dimension           = 2
periodic directions         = [0, 1]
spinful                     = False
number of spin components   = 1
number of electronic states = 2
number of orbitals          = 2

Lattice vectors (Cartesian):
  # 0 ===> [ 1.000,  0.000]
  # 1 ===> [ 0.000,  1.000]
Volume of unit cell (Cartesian) = 1.000 [A^d]

Reciprocal lattice vectors (Cartesian):
  # 0 ===> [ 6.283,  0.000]
  # 1 ===> [ 0.000,  6.283]
Volume of reciprocal unit cell = 39.478 [A^-d]

Orbital vectors (Cartesian):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.500]

Orbital vectors (fractional):
  # 0 ===> [ 0.000,  0.000]
  # 1 ===> [ 0.500,  0.500]
----------------------------------------
Site energies:
  < 0 | H | 0 > =  1.000 
  < 1 | H | 1 > =  1.000 
Hoppings:
  < 0 | H | 1  + [ 0.0 ,  0.0 ] > = 0.8000+0.0000j
  < 1 | H | 0  + [ 0.0 ,  1.0 ] > = 't2'
Hopping distances:
  | pos( 0 ) - pos( 1 ) + [ 0.0 ,  0.0 ] | =   0.707
  | pos( 1 ) - pos( 0 ) + [ 0.0 ,  1.0 ] | =   0.707 (param)

```

如果我们希望在冻结参数后将其恢复为符号形式，可以使用与最初构建模型时相同的方法，即 set_onsite和 set_hop函数。在此，我们重新将 onsite 能量设置为依赖参数 m。

```python

model.set_onsite("m", ind_i=0)
model.set_onsite("m", ind_i=1)

```