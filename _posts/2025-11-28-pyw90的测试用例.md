---
layout: post
title: "pyw90的测试用例"
subtitle: "Experience Sharing"
background: '/img/bg-sci-note.jpg'
categories: sci-note
permalink: /sci-note_posts/20251128-pyw-test
---

https://github.com/Cloudiiink/pyw90/blob/master/README.md


创建虚拟环境
```shell
conda create -n wannier-env python=3.9 -y
python3 -m venv pyw90-env
```

激活环境 并安装
```shell

conda activate wannier-env

pip install pywannier90 -i https://pypi.tuna.tsinghua.edu.cn/simple

source pyw90-env/bin/activate

pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pywannier90

```
## <center>流程与步骤</center>

例子选取于上方网址，作为学习交流使用，切勿用作他途。


假设你已经熟悉wannier90，并且如下方所示准备好文件夹,此为示例中的文件结构，实际上我位于我自己的能带计算的文件夹中运行的命令

```shell

examples/GaAs
├── bnd
│   ├── INCAR
│   ├── KPOINTS  
│   └── POSCAR
├── wannier  <-- Current working dir
│   ├── afolder  
│   ├── wannier90_input.win
│   └── wannier90.win 
├── GaAs_mp-2534_primitive.cif
├── INCAR 
├── KPOINTS
├── POSCAR
├── run.script
└── vasprun.xml

```

通过eig菜单显示特征值分布：

```shell

pyw90 eig dist --path ./

```
结果为：
```shell

Calculated Energy Range: -1000.0, 1000.0 with Fermi level -1.062223
EFERMI: -1.062223
--------------------------------
Band No.     EMIN        EMAX
--------------------------------
  0~  1   -57.17729   -57.16076
  2~  3   -56.71744   -56.70345
  4~  5   -34.73038   -34.52053
  6~  7   -34.46820   -34.32246
  8~  9   -32.92932   -32.67502
 10~ 11   -32.63085   -32.38184
 12~ 13   -32.28038   -32.15578
 14~ 15   -32.00534   -31.79921
 16~ 17   -22.00339   -20.63706
 18~ 19   -14.49020   -13.94002
 20~ 21   -13.71047   -13.59545
 22~ 27    -9.34939    -6.48335
 28~ 29    -6.25174    -5.36166
 30~ 31    -5.34394    -4.75866
 32~ 39    -4.74306    -2.65443
 40~ 43    -2.61865    -1.10017
 44~ 63    -1.02199    +5.69667
--------------------------------


```
也可以将结果输出为pdf格式，且是某个波段的能量分布到文件夹中。

运行下方指令得到一些关于能量窗口的建议：

```shell

pyw90 eig suggest --path ./

```
结果：
```shell

Calculated Energy Range: -1000.0, 1000.0 with Fermi level -1.062223
There are at most 64 states and at least 64 states in [-1000.0, 1000.0].

`dis_win_min` and `dis_win_max` Table:
    Column `dis_win_max` shows the **lowest** dis_win_max for `dis_win_min`
    Column `i+1_min` / `i_max` shows the band minimum / maximum near the gap
    Column `Nleast`  / `Nmost` shows the least / most number of states inside `dis_win_min` and Fermi level.

    dis_win_min    i+1_min      i_max  Nleast  Nmost
14    -2.636541  -2.618654  -2.654429       4      4
13    -4.750860  -4.743057  -4.758664      12     12
12    -5.352798  -5.343936  -5.361660      14     14
11    -6.367546  -6.251741  -6.483351      16     16
10   -11.472421  -9.349394 -13.595448      22     22
9    -13.825247 -13.710470 -13.940024      24     24
8    -17.563633 -14.490202 -20.637063      26     26
7    -26.901300 -22.003393 -31.799208      28     28
6    -32.080560 -32.005339 -32.155781      30     30
5    -32.331113 -32.280383 -32.381843      32     32
4    -32.652936 -32.630852 -32.675020      34     34
3    -33.625889 -32.929317 -34.322462      36     36
2    -34.494366 -34.468205 -34.520528      38     38
1    -45.716912 -34.730376 -56.703448      40     40
0    -56.939097 -56.717439 -57.160755      42     42


```

运行指令得到建议投影的轨道并产生wannier90.in。

此处，我们选择费米能级附近 [-1, 1] eV​ 的能量区间进行评估，以得出最具代表性的投影权重建议

也可以通过调整相应参数来修改能量区间的选择下限，以观察输出结果的变化。

```shell

pyw90 pre dos --path .. -e -1 1 --rm-fermi --plot

```

结果：

```shell

Reading vasprun.xml file from
    `/public/home/cssong/song/1mrx/17_AL_stack/26_Nb2OSe2_better/U=1.5/monolayer/new_wannier/1_k=11_wannier/1_static_ncl/选取合适的轨道/2_bandsoc/vasprun.xml` 
for DOS analysis...
    Fermi level : -1.06222 eV
    DOS Gap     : 0.00000 eV

Calculated DOS Energy Range: -2.06222313, -0.062223130000000015


   species  structure_id  orb_id orb_name key_string       dos
6       Nb             0       6      dz2   Nb_0_dz2  1.000000
15      Nb             1       6      dz2   Nb_1_dz2  0.999915
13      Nb             1       4      dxy   Nb_1_dxy  0.465896
4       Nb             0       4      dxy   Nb_0_dxy  0.465808
14      Nb             1       5      dyz   Nb_1_dyz  0.462808
7       Nb             0       7      dxz   Nb_0_dxz  0.462613
8       Nb             0       8      dx2   Nb_0_dx2  0.217618
17      Nb             1       8      dx2   Nb_1_dx2  0.217514
38       O             4       2       pz     O_4_pz  0.171881
29      Se             3       2       pz    Se_3_pz  0.141651
20      Se             2       2       pz    Se_2_pz  0.092454
19      Se             2       1       py    Se_2_py  0.085562
21      Se             2       3       px    Se_2_px  0.085500
30      Se             3       3       px    Se_3_px  0.079113
28      Se             3       1       py    Se_3_py  0.079034
39       O             4       3       px     O_4_px  0.046104
37       O             4       1       py     O_4_py  0.046043
0       Nb             0       0        s     Nb_0_s  0.042437
9       Nb             1       0        s     Nb_1_s  0.042437
18      Se             2       0        s     Se_2_s  0.022024
27      Se             3       0        s     Se_3_s  0.017021
22      Se             2       4      dxy   Se_2_dxy  0.012715
24      Se             2       6      dz2   Se_2_dz2  0.011391
26      Se             2       8      dx2   Se_2_dx2  0.011267
35      Se             3       8      dx2   Se_3_dx2  0.009700
33      Se             3       6      dz2   Se_3_dz2  0.008872
12      Nb             1       3       px    Nb_1_px  0.007934
1       Nb             0       1       py    Nb_0_py  0.007934
5       Nb             0       5      dyz   Nb_0_dyz  0.006255
16      Nb             1       7      dxz   Nb_1_dxz  0.006255
10      Nb             1       1       py    Nb_1_py  0.005645
3       Nb             0       3       px    Nb_0_px  0.005645
23      Se             2       5      dyz   Se_2_dyz  0.004173
25      Se             2       7      dxz   Se_2_dxz  0.004173
31      Se             3       4      dxy   Se_3_dxy  0.004089
34      Se             3       7      dxz   Se_3_dxz  0.003537
32      Se             3       5      dyz   Se_3_dyz  0.003537
36       O             4       0        s      O_4_s  0.002686
2       Nb             0       2       pz    Nb_0_pz  0.000509
11      Nb             1       2       pz    Nb_1_pz  0.000497
40       O             4       4      dxy    O_4_dxy  0.000000
41       O             4       5      dyz    O_4_dyz  0.000000
42       O             4       6      dz2    O_4_dz2  0.000000
43       O             4       7      dxz    O_4_dxz  0.000000
44       O             4       8      dx2    O_4_dx2  0.000000

Based on your input, set the lower selection bound to 0.1 and 10 orbitals are selected.
Number of WFs selected: 10 (with degeneracy 1)

Orbitals Selected: 
  species site                   orb
0      Nb    0  [dxy, dz2, dxz, dx2]
1      Nb    1  [dxy, dyz, dz2, dx2]
2      Se    3                  [pz]
3       O   -1                  [pz]

Wannier90 Projection:
f=0.000001,0.500000,0.503618:dxy;dz2;dxz;dx2-y2
f=0.500000,0.999999,0.503621:dxy;dyz;dz2;dx2-y2
f=0.999999,0.000001,0.396013:pz
O:pz

pyw90 --extra input:
Nb,0,4|6-8;Nb,1,4-6|8;Se,3,2;O,4,2

Plotted with selected orbitals in `brown` and non-selected orbitals in `orange`.
Plotted with a total of 24 orbitals, 10 of which are selected.
Figure should be stored at /public/home/cssong/song/1mrx/17_AL_stack/26_Nb2OSe2_better/U=1.5/monolayer/new_wannier/1_k=11_wannier/1_static_ncl/选取合适的轨道/2_bandsoc/dos_analysis.pdf


```

尝试修改上下限：

```shell

pyw90 pre dos --path ./ -e -2 2 --rm-fermi --plot

```


```shell

Reading vasprun.xml file from
    `/public/home/cssong/song/1mrx/17_AL_stack/26_Nb2OSe2_better/U=1.5/monolayer/new_wannier/1_k=11_wannier/1_static_ncl/选取合适的轨道/2_bandsoc/vasprun.xml` 
for DOS analysis...
    Fermi level : -1.06222 eV
    DOS Gap     : 0.00000 eV

Calculated DOS Energy Range: -3.06222313, 0.93777687


   species  structure_id  orb_id orb_name key_string       dos
14      Nb             1       5      dyz   Nb_1_dyz  1.000000
7       Nb             0       7      dxz   Nb_0_dxz  0.999150
15      Nb             1       6      dz2   Nb_1_dz2  0.957923
6       Nb             0       6      dz2   Nb_0_dz2  0.957750
13      Nb             1       4      dxy   Nb_1_dxy  0.490933
4       Nb             0       4      dxy   Nb_0_dxy  0.490911
17      Nb             1       8      dx2   Nb_1_dx2  0.303780
8       Nb             0       8      dx2   Nb_0_dx2  0.303752
16      Nb             1       7      dxz   Nb_1_dxz  0.287098
5       Nb             0       5      dyz   Nb_0_dyz  0.287097
38       O             4       2       pz     O_4_pz  0.216118
30      Se             3       3       px    Se_3_px  0.165473
28      Se             3       1       py    Se_3_py  0.165409
19      Se             2       1       py    Se_2_py  0.148639
21      Se             2       3       px    Se_2_px  0.148499
29      Se             3       2       pz    Se_3_pz  0.098211
37       O             4       1       py     O_4_py  0.081851
39       O             4       3       px     O_4_px  0.081809
20      Se             2       2       pz    Se_2_pz  0.074695
0       Nb             0       0        s     Nb_0_s  0.032390
9       Nb             1       0        s     Nb_1_s  0.032390
26      Se             2       8      dx2   Se_2_dx2  0.021172
35      Se             3       8      dx2   Se_3_dx2  0.018524
12      Nb             1       3       px    Nb_1_px  0.012137
1       Nb             0       1       py    Nb_0_py  0.012137
18      Se             2       0        s     Se_2_s  0.011819
27      Se             3       0        s     Se_3_s  0.010019
22      Se             2       4      dxy   Se_2_dxy  0.010018
3       Nb             0       3       px    Nb_0_px  0.009842
10      Nb             1       1       py    Nb_1_py  0.009842
24      Se             2       6      dz2   Se_2_dz2  0.008653
31      Se             3       4      dxy   Se_3_dxy  0.006800
33      Se             3       6      dz2   Se_3_dz2  0.006723
25      Se             2       7      dxz   Se_2_dxz  0.006332
23      Se             2       5      dyz   Se_2_dyz  0.006332
32      Se             3       5      dyz   Se_3_dyz  0.005652
34      Se             3       7      dxz   Se_3_dxz  0.005652
36       O             4       0        s      O_4_s  0.005392
2       Nb             0       2       pz    Nb_0_pz  0.002285
11      Nb             1       2       pz    Nb_1_pz  0.002281
40       O             4       4      dxy    O_4_dxy  0.000000
41       O             4       5      dyz    O_4_dyz  0.000000
42       O             4       6      dz2    O_4_dz2  0.000000
43       O             4       7      dxz    O_4_dxz  0.000000
44       O             4       8      dx2    O_4_dx2  0.000000

Based on your input, set the lower selection bound to 0.1 and 15 orbitals are selected.
Number of WFs selected: 15 (with degeneracy 1)

Orbitals Selected: 
  species site       orb
0      Nb   -1       [d]
1      Se   -1  [py, px]
2       O   -1      [pz]

Wannier90 Projection:
Nb:l=2
Se:py;px
O:pz

pyw90 --extra input:
Nb,0-1,4-8;Se,2-3,1|3;O,4,2

Plotted with selected orbitals in `brown` and non-selected orbitals in `orange`.
Plotted with a total of 28 orbitals, 15 of which are selected.
Figure should be stored at /public/home/cssong/song/1mrx/17_AL_stack/26_Nb2OSe2_better/U=1.5/monolayer/new_wannier/1_k=11_wannier/1_static_ncl/选取合适的轨道/2_bandsoc/dos_analysis.pdf

```

可以看出拟合能带的能量范围不同，投影轨道的数目也不同。

随后，我们可以将能量范围调整至一个非常大的区间：

```shell

pyw90 pre dos --path ./ -e -4.750 10 --extra 'Nb,1-2,4-8;Se,1-2,1-2;O,1,2'

```
其中，第一个“1-2”是Nb的原子编号，“4-8”为轨道编号，其余元素的格式同理。上一步中的靠后部分有这些编号的output

结果为：

```shell

Reading vasprun.xml file from
    `/public/home/cssong/song/1mrx/17_AL_stack/26_Nb2OSe2_better/U=1.5/monolayer/new_wannier/1_k=11_wannier/1_static_ncl/未选择详细的轨道划分/2_bandsoc/vasprun.xml` 
for DOS analysis...
    Fermi level : -1.06222 eV
    DOS Gap     : 0.00000 eV

Calculated DOS Energy Range: -4.75, 10.0

/public/home/cssong/.conda/envs/pyw90_env/lib/python3.10/site-packages/pyw90/lib/dos.py:294: UserWarning: CHECK YOUR INPUT! The energies in `EIGENVAL` is ranged from -60.321 to 8.8404, which does not include all the energy ranged from -4.75 to 10.0 you input.
  warnings.warn(f'CHECK YOUR INPUT! The energies in `EIGENVAL` is ranged from {ee.min()} to {ee.max()}, ' \

Dis frozen window table
The table is sorted according to the percentage of pdos/tdos.
If you want to see `dis_win_min(max)` suggestion, please use `pyw90 eig suggest` menu.
    dis_froz_min  dis_froz_max   N      pdos       tdos   percent
12     -1.358146      2.597391  15  5.125143  15.016646  0.341297
11     -1.358146      2.596727  15  5.120804  15.004925  0.341275
8      -2.650429      1.755243  15  4.246392  12.995824  0.326751
5      -3.083025      1.135878  14  2.551449   7.878292  0.323858
9      -1.531936      2.247293  15  2.798732   8.641846  0.323858
6      -3.082851      1.208709  15  2.315049   7.186904  0.322120
10     -1.463430      2.336010  15  2.849126   8.861746  0.321508
14     -0.112658      2.983559  15  3.492113  11.016557  0.316988
7      -2.706902      1.633854  15  3.199764  10.100167  0.316803
13     -0.202382      2.914169  15  3.215031  10.281857  0.312690
15      0.766397      3.448345  15  2.469691   8.225589  0.300245
16      0.893846      3.464538  15  2.465737   8.294854  0.297261
4      -3.710088      0.909337  15  6.145274  22.344695  0.275022
17      1.111615      6.000000  14  2.832842  10.665791  0.265601
1      -4.116381      0.216475  15  2.340062   9.284414  0.252042
3      -3.844320      0.681424  15  3.660646  14.722510  0.248643
2      -4.095046      0.369728  15  2.060050   8.285811  0.248624
0      -4.754664     -0.099691  15  3.605248  16.794415  0.214669

Lowest `dis_win_max` for -4.75: 0.766397


```
轨道编号参考(vasp5.4.4与vasp6.4.3应当相同)
```shell

四、轨道编号在 pyw90 中的固定对应（兼容 VASP 6.4.3）
编号	轨道类型	对应 VASP 通道	pyw90/ pymatgen 轨道名
0	s	s	s
1	p	py	py
2	p	pz	pz
3	p	px	px
4	d	dxy	dxy
5	d	dyz	dyz
6	d	dz2	dz2
7	d	dxz	dxz
8	d	dx2–y2	dx2–y2
9–15	f	f1–f7	f 轨道组

```

由此，我们获得了Wannier函数的初始猜测。随后，我们可以使用命令 pyw90 pre template --extra basic来为 Wannier90​ 与 VASP​ 的接口生成 .wannier90.win模板文件。

由于（VASP版本 <6.0）仅支持 Wannier90 1.2​ 版本的接口。可能需要修改并重新编译接口代码，使其能够计算非共线Wannier函数并支持旋量投影方法。更多详细信息，请参考项目：
Chengcheng-Xiao/VASP2WAN90_v2_fix（一个更新版的VASP2WANNIER90v2接口）。

此处由于不识别“|”符号，所以可以手写win文件：

```shell

num_wann  = 30
!num_bands = 15

!exclude_bands : 1-5

begin projections
Nb:l=2
Se:py;px
O:pz
end projections

spinors = .true.

```

此文件 (wannier90.win) 需在 wannier文件夹内创建。同时，必须在 INCAR文件中设置 LWANNIER90 = .TRUE.以启用 VASP与 Wannier90之间的接口。

此功能（VASP-Wannier90接口）仅在 VASP 编译时启用了 -DVASP2WANNIER90或 -DVASP2WANNIER90v2选项才可用。

其他输入参数（如 kpoints- k点列表，atoms- 原子位置，unit_cell- 晶胞矢量，mp_grid- Monkhorst-Pack网格尺寸等）将基于 VASP计算的信息自动设置。

对于 VASP (>= 6.2.0) 版本，它将支持 Wannier90>=3.0。并且，wannier90.win输入文件的内容可以直接通过 INCAR文件中的 WANNIER90_WIN参数输入（参见 Vaspwiki 上的 WANNIER90_WIN 条目），不再需要单独的初始 wannier90.win文件。

执行计算任务后，VASP会为后续的 WANNIER90运行写入所需的输入文件：wannier90.win, wannier90.mmn, wannier90.eig以及 wannier90.amn。

这里我们将 disentanglement (dis) 能量窗口的初始猜测和能带结构计算的路径卡片写入 wannier90.win文件。其中 Kpoint_Path模块可以通过命令 pyw90 pre kpath --path ../bnd生成（此命令可能利用之前能带计算 ../bnd的路径信息）。


开始第一次wannier90能带拟合，具体过程参考之前的教程

```shell


kmesh_tol=0.00001

begin projections
Nb:l=2
Se:py;px
O:pz
end projections

dis_froz_min  = -1.358
dis_froz_max  =  2.597
dis_win_min   = -4.75
dis_win_max   = 0.766397


```
我使用的是vasp6.4.3的版本，写在INCAR内即可，不需要单独的win文件。


随后，我们可以使用 pyw90 auto菜单来自动优化 disentanglement 能量窗口。配置文件应使用 pyw90 auto input命令生成。在运行计算之前，请自定义该配置文件（有关每个参数键的含义，
请参阅该菜单的文档）。


先进行wannier90的能带拟合，得到wannier90_band.dat等等文件。

准备好所有输入文件后，键入 pyw90 auto run来执行该流程。会产生两个输出文件。

我们一步一步进行。

先运行脚本

```shell

pyw90 auto run

```

产生auto_w90_input.yaml文件，修改其中的内容与slurm系统的匹配

再修改yml文件中的参数

```shell
# kernal function used to evalute the quality of Wannier90 band
kernel: [unit, 0, 1]
```

或

```shell
# kernal function used to evalute the quality of Wannier90 band
kernel: [gaussian, 0, 2]
```

编辑提交任务脚本w90.script

```shell

#!/bin/bash
#PBS -l nodes=node15:ppn=64
#PBS -l walltime=24:00:00
#PBS -j oe
#PBS -q sugon
#PBS -N w90   

cd $PBS_O_WORKDIR

echo "------------------------------------"
echo "Wannier90 job started at: $(date)"
echo "Job ID: $PBS_JOBID"
echo "Working directory: $(pwd)"
echo "------------------------------------"

# 模块加载
source /public/software/profile.d/compiler_intel-compiler-2021.3.0.sh 
source /public/software/profile.d/mpi_intelmpi-2021.3.0.sh 

# Conda 环境激活（请确认路径）
source /public/software/profile.d/apps_anaconda3-2021.05.sh
conda activate pyw90_env

# 确认环境加载正确
echo "Python path: $(which python)"
python -c "import pyw90; print('Pyw90 path:', pyw90.__file__)"

# 运行 W90
EXE=/public/home/xpwu/pack/wannier90-3.1.0/bin/wannier90.x
SYSTEM="wannier90" 

NP=$(cat $PBS_NODEFILE | wc -l)
cat $PBS_NODEFILE | uniq -c | awk '{ printf("%s:%s\n", $2, $1); }' > $PBS_JOBID-$PBS_JOBCOOKIE.hosts

echo "Running Wannier90 on $NP cores..."
mpirun -np $NP $EXE $SYSTEM > wannier90.log

echo "------------------------------------"
echo "Wannier90 job finished at: $(date)"
echo "------------------------------------"

rm -f $PBS_JOBID-$PBS_JOBCOOKIE.hosts


```
然后运行自动分析程序

```shell

pyw90 auto run

```

等待即可。

此刻凌晨3：20了，稍后睡醒再写一篇如何修改正确参数来进行能量窗口计算的文章。